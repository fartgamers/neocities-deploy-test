<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gamepad Vibration</title>
</head>
<body>

  <button id="vibrateButton">Vibrate!</button>
  <br>
  <label for="intensitySlider">Vibration Intensity:</label>
  <input type="range" id="intensitySlider" min="0" max="1" step="0.1" value="1">

  <script>
    let vibrating = false;
    let gamepadIndex = null;
    let vibrationInterval = null;
    let dpadIntensityAdjustInterval = null;

    const button = document.getElementById('vibrateButton');
    const intensitySlider = document.getElementById('intensitySlider');

    function startVibrating(gamepad) {
      const intensity = parseFloat(intensitySlider.value);
      gamepad.vibrationActuator.playEffect('dual-rumble', {
        startDelay: 0,
        duration: 500,  // short vibration
        weakMagnitude: intensity,
        strongMagnitude: intensity
      });
    }

    function adjustIntensity(delta) {
      let newIntensity = parseFloat(intensitySlider.value) + delta;
      newIntensity = Math.min(Math.max(newIntensity, 0), 1);
      intensitySlider.value = newIntensity;
    }

    button.addEventListener('click', () => {
      if (gamepadIndex !== null) {
        const gamepad = navigator.getGamepads()[gamepadIndex];
        if (gamepad && gamepad.vibrationActuator) {
          if (vibrating) {
            clearInterval(vibrationInterval);
            gamepad.vibrationActuator.playEffect('dual-rumble', {
              startDelay: 0,
              duration: 0,  // stop the vibration
              weakMagnitude: 0,
              strongMagnitude: 0
            });
            button.textContent = 'Vibrate!';
          } else {
            startVibrating(gamepad);
            vibrationInterval = setInterval(() => startVibrating(gamepad), 300);  // repeat every 300ms
            button.textContent = 'Stop!';
          }
          vibrating = !vibrating;
        } else {
          console.log('Vibration not supported on this gamepad.');
        }
      } else {
        console.log('No gamepad connected.');
      }
    });

    function checkDpadInput() {
      const gamepads = navigator.getGamepads();
      if (gamepads[gamepadIndex]) {
        const gamepad = gamepads[gamepadIndex];
        if (gamepad.buttons[14].pressed) { // D-pad left
          adjustIntensity(-0.1);
        }
        if (gamepad.buttons[15].pressed) { // D-pad right
          adjustIntensity(0.1);
        }
      }
    }

    window.addEventListener('gamepadconnected', (event) => {
      console.log('Gamepad connected:', event.gamepad);
      gamepadIndex = event.gamepad.index;
      dpadIntensityAdjustInterval = setInterval(checkDpadInput, 100);  // check for d-pad input every 100ms
    });

    window.addEventListener('gamepaddisconnected', (event) => {
      console.log('Gamepad disconnected:', event.gamepad);
      if (gamepadIndex === event.gamepad.index) {
        clearInterval(vibrationInterval);
        clearInterval(dpadIntensityAdjustInterval);
        gamepadIndex = null;
        vibrating = false;
        button.textContent = 'Vibrate!';
      }
    });
  </script>

</body>
</html>
