<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://fonts.googleapis.com/css2?family=Martian+Mono:wght@700&family=PT+Sans&display=swap" rel="stylesheet">
	<title>Gamepad Vibration</title>
	<meta name="robots" content="noindex">
	<style>
		* {box-sizing: border-box;}
		body {
			font-family: 'PT Sans', sans-serif;
			background-color: black;
		}
		h1, h2, h3, h4 {
			font-family: 'Martian Mono', monospace;
			color: var(--bright);
		}
		.waiter {
			--bright: #ffee00;
			--bg: #1d1c14;
			--color: #ede68c;
		}
		.error {
			--bright: red;
			--bg: #231918;
			--color: #ffdad4;
		}
		.success {
			--bright: #00ff00;
			--bg: #181d18;
			--color: #b6f1bb;
			--light: #285020;
			--on-light: #a5d395;
			--dark: #002200;
			--on-dark: #c0efb0;
		}
		.disconnected {
			--bright: #ff8c00;
			--bg: #211a14;
			--color: #ffdcbc;
		}
		main {
			width: 300px;
			height: 500px;
			border: 1px solid var(--bright);
			background-color: var(--bg);
			color: var(--color)
		}
		button {
			font-family: 'Martian Mono', monospace;
			border: 1px solid var(--bright);
			background-color: var(--dark);
			color: var(--on-dark);
			box-shadow: 2px 2px 0 0 var(--bright);
			margin-top: 3px;
			cursor: pointer;
		}
		button:hover {
			transform: translate(1px, 1px);
			box-shadow: 1px 1px 0 0 var(--bright);
		}
		button:active, #intensitySlider::-webkit-slider-thumb:active {
			transform: translate(2px, 2px);
			box-shadow: none;
		}
		.mainer {
			display: none;
			height: 100%;
		}
		.waiter #waiting, .error #unsupported, .success #interface, .disconnected #disconnect {display: flex;}
		.informal {
			flex-direction: column;
			justify-content: space-around;
			text-align: center;
			padding: 5px;
		}
		#interface {
			flex-direction: column;
			padding: 10px;
			padding-top: 7px;
		}
		#dropdownbutton {
			margin-top: 10px;
			width: 100%;
			padding: 3px;
		}
		.dropdown {
			position: relative;
			display: inline-block;
		}
		#selections {
			margin-top: 5px;
			display: none;
			position: absolute;
			z-index: 1;
			background-color: var(--dark);
			border: 1px solid var(--bright);
		}
		#selections a {
			display: block;
			font-size: 16px;
			padding: 5px;
			font-family: 'Martian Mono', monospace;
			color: var(--on-dark);
			cursor: pointer;
		}
		#selections a:hover {
			background-color: var(--light);
			color: var(--bright);
		}
		#vibrateButton {
			font-size: 24px;
			height: 80px;
		}
		.vibrating {
			background-color: var(--light);
			color: var(--bright);
		}
		#slider {
			width: 100%;
			margin-top: 10px;
		}
		#intensitySlider {
			appearance: none;
			width: 100%;
			height: 10px;
			background: linear-gradient(90deg, var(--bright) 0%, var(--bright) 50%, var(--dark) 50%, var(--dark) 100%);
			outline: none;
			border: 1px solid var(--bright);
			margin: 0;
		}
		#intensitySlider::-webkit-slider-thumb {
			appearance: none;
			width: 25px;
			height: 25px;
			background-color: var(--dark);
			border: 1px solid var(--bright);
			box-shadow: 2px 2px 0 0 var(--bright);
		}
		canvas {
			margin-top: 10px;
			border: 1px solid var(--bright);
			background-color: var(--dark);
		}
	</style>
</head>
<body>
	<main id="main" class="waiter">
		<div id="waiting" class="mainer informal">
			<h2>PLEASE CONNECT CONTROLLER</h2>
			<p>if your controller is connected, just press a button on it. any ol' button will do</p>
		</div>
		<div id="unsupported" class="mainer informal">
			<h2>CONTROLLER UNSUPPORTED</h2>
			<p>this controller just isn't supported, sorry =(</p>
		</div>
		<div id="disconnect" class="mainer informal">
			<h2>CONTROLLER DiSCONNECTED!</h2>
			<p>it appears that your controller has been disconnected. reconnect that baby!</p>
		</div>
		<div id="interface" class="mainer">
			<button id="vibrateButton">Vibrate!</button>
			<div id="slider">
				<input type="range" id="intensitySlider" min="0" max="1" step="0.1" value="0.5">
			</div>
			<div class="dropdown">
				<button id="dropdownbutton" onclick="toggleDropdown()">MODE: normal</button>
				<div id="selections">
					<a onclick="setVibrationMode('normal');">Normal</a>
					<a onclick="setVibrationMode('oscillate');">Oscillating</a>
					<a onclick="setVibrationMode('random');">Random</a>
					<a onclick="setVibrationMode('heartbeat');">Heartbeat</a>
					<a onclick="setVibrationMode('wave');">Wave</a>
					<a onclick="setVibrationMode('pulse');">Pulse</a>
					<a onclick="setVibrationMode('crescendo');">Crescendo</a>
					<a onclick="setVibrationMode('echo');">Echo</a>
					<a onclick="setVibrationMode('stutter');">Stutter</a>
				</div>
			</div>
			<canvas id="waveCanvas" width="500" height="200"></canvas>
		</div>
	</main>
	<script>
let vibrating = false;
let vibrationMode = 'normal';
let gamepadIndex = null;
let vibrationInterval = null;
let dpadIntensityAdjustInterval = null;
let oscillationValue = 0;
let increasing = true;
let crescendoValue = 0;

const button = document.getElementById('vibrateButton');
const intensitySlider = document.getElementById('intensitySlider');
const oscillateSpeedInput = document.getElementById('oscillateSpeed');
const pulseDurationInput = document.getElementById('pulseDuration');

function vibrate(gamepad, magnitude, duration) {
	gamepad.vibrationActuator.playEffect('dual-rumble', {
		startDelay: 0,
		duration: duration,
		weakMagnitude: magnitude,
		strongMagnitude: magnitude
	});
}

function regularVibration(gamepad, intensity) {vibrate(gamepad, intensity, intensity);}
function oscillateVibration(gamepad) {
	const baseIntensity = parseFloat(intensitySlider.value);
	const speed = 100;
	const intensity = baseIntensity * (oscillationValue / 100);
	vibrate(gamepad, intensity, 300)
	if (increasing) {
		oscillationValue += 1;
		if (oscillationValue >= 100) {increasing = false;}
	} else {
		oscillationValue -= 1;
		if (oscillationValue <= 0) {increasing = true;}
	}
}
function randomVibration(gamepad) {
	const intensity = Math.random();
	vibrate(gamepad, intensity, 300)
}
function heartbeatVibration(gamepad) {
	const intensity = parseFloat(intensitySlider.value);
	vibrate(gamepad, 1.0, 100);
	setTimeout(() => vibrate(gamepad, intensity, 300), 300);
	setTimeout(() => vibrate(gamepad, 1.0, 100), 600);
}
function waveVibration(gamepad) {
	const baseIntensity = parseFloat(intensitySlider.value);
	const intensity = (Math.sin(Date.now() / 1000) + 1) / 2 * baseIntensity;
	vibrate(gamepad, intensity, 300)
}
function pulseVibration(gamepad) {
	const intensity = parseFloat(intensitySlider.value);
	const duration = 100;
	vibrate(gamepad, intensity, duration);
}
function crescendoVibration(gamepad) {
	const baseIntensity = parseFloat(intensitySlider.value);
	const intensity = crescendoValue / 100 * baseIntensity;
	vibrate(gamepad, intensity, 300)
	crescendoValue += 1;
	if (crescendoValue > 100) {crescendoValue = 0;}
}
function echoVibration(gamepad) {
	const intensity = parseFloat(intensitySlider.value);
	vibrate(gamepad, intensity, intensity, 100);
	setTimeout(() => vibrate(gamepad, intensity * 0.5, 100), 200);
	setTimeout(() => vibrate(gamepad, intensity * 0.25, 100), 400);
}
function stutterVibration(gamepad) {
	const intensity = parseFloat(intensitySlider.value);
	vibrate(gamepad, intensity, 20);
}

const vibrationModes = {
	normal: regularVibration,
	oscillate: oscillateVibration,
	random: randomVibration,
	heartbeat: heartbeatVibration,
	wave: waveVibration,
	pulse: pulseVibration,
	crescendo: crescendoVibration,
	echo: echoVibration,
	stutter: stutterVibration
};
function setVibrationMode(mode) {
	vibrationMode = mode;
	document.getElementById('selections').style.display = 'none';
	document.getElementById('dropdownbutton').innerHTML = `MODE: ${mode}`;
}

button.addEventListener('click', () => {
	if (gamepadIndex !== null) {
		const gamepad = navigator.getGamepads()[gamepadIndex];
		if (gamepad && gamepad.vibrationActuator) {
			toggleAnimation();
			if (vibrating) {
				clearInterval(vibrationInterval);
				vibrate(gamepad, 0, 0, 0);
				button.textContent = 'Vibrate!';
				button.classList.remove('vibrating');
			} else {
				if (vibrationMode === 'normal') {
					vibrationInterval = setInterval(() => vibrate(gamepad, parseFloat(intensitySlider.value), 300), 100);
				} else {vibrationInterval = setInterval(() => vibrationModes[vibrationMode](gamepad), 100);}
				button.textContent = 'Stop!';
				button.classList.add('vibrating');
			}
			vibrating = !vibrating;
		} else {document.getElementById('main').classList = 'error';}
	} else {console.log('No gamepad connected.');}
});

function adjustIntensity(delta) {
	let newIntensity = parseFloat(intensitySlider.value) + delta;
	newIntensity = Math.min(Math.max(newIntensity, 0), 1);
	intensitySlider.value = newIntensity;
}
function checkDpadInput() {
	const gamepads = navigator.getGamepads();
	if (gamepads[gamepadIndex]) {
		const gamepad = gamepads[gamepadIndex];
		if (gamepad.buttons[14].pressed) {adjustIntensity(-0.1);}
		if (gamepad.buttons[15].pressed) {adjustIntensity(0.1);}
	}
}
window.addEventListener('gamepadconnected', (event) => {
	console.log('Gamepad connected:', event.gamepad);
	document.getElementById('main').classList = 'success';
	gamepadIndex = event.gamepad.index;
	dpadIntensityAdjustInterval = setInterval(checkDpadInput, 100);
});
window.addEventListener('gamepaddisconnected', (event) => {
	console.log('Gamepad disconnected:', event.gamepad);
	document.getElementById('main').classList = 'disconnected';
	if (gamepadIndex === event.gamepad.index) {
		clearInterval(vibrationInterval);
		clearInterval(dpadIntensityAdjustInterval);
		gamepadIndex = null;
		vibrating = false;
		button.textContent = 'Vibrate!';
	}
});

// Toggle dropdown function
function toggleDropdown() {
	var ddown = document.getElementById('selections');
	if (ddown.style.display === 'block') {
		ddown.style.display = 'none';
	} else {ddown.style.display = 'block';}
}

// Update the background of the slider
var slidey = document.getElementById('intensitySlider');
slidey.oninput = function() {
	const sliderLot = slidey.value * 100;
	slidey.style.background = 'linear-gradient(90deg, var(--bright) 0%, var(--bright) ' + sliderLot + '%, var(--dark) ' + sliderLot + '%, var(--dark) 100%)';
}

// Draws waves
const canvas = document.getElementById('waveCanvas');
const ctx = canvas.getContext('2d');
let waveHeight = slidey.value;
let offset = 0;
let animationId;
function drawWave() {
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	ctx.beginPath();
	ctx.lineWidth = 5;
	ctx.strokeStyle = '#00ff00';
	const waveLength = 100;
	const waveCount = Math.ceil(canvas.width / waveLength) + 1;
	ctx.moveTo(-offset, canvas.height / 2);
	for (let i = 0; i < waveCount; i++) {
		const x = i * waveLength - offset;
		const y = canvas.height / 2;
		ctx.quadraticCurveTo(x + waveLength / 4, y - waveHeight * canvas.height / 2, x + waveLength / 2, y);
		ctx.quadraticCurveTo(x + 3 * waveLength / 4, y + waveHeight * canvas.height / 2, x + waveLength, y);
	}
	ctx.stroke();
}
function update() {
	offset += 2;
	if (offset > 100) {offset = 0;}
	drawWave();
	animationId = requestAnimationFrame(update);
}
function toggleAnimation() {
	if (vibrating) {cancelAnimationFrame(animationId);} else {
		offset = 0;
		update();
	}
}
slidey.addEventListener('input', () => {
	waveHeight = slidey.value;
	drawWave();
});
drawWave();
</script>
</body>
</html>